#!/usr/sbin/nft -f

flush ruleset

# Mangle table for MSS clamping (MTU fixing) and packet marking
table inet mangle {
    chain forward {
        type filter hook forward priority mangle; policy accept;

        # MSS clamping for prague0 WireGuard tunnel (MTU 1380)
        # Clamp to 1340 (1380 - 40 bytes for IP+TCP headers)
        oifname "prague0" tcp flags syn tcp option maxseg size set 1340 counter comment "MSS clamp outbound prague0"
        iifname "prague0" tcp flags syn tcp option maxseg size set 1340 counter comment "MSS clamp inbound prague0"
    }

    chain prerouting {
        type filter hook prerouting priority mangle; policy accept;

        # Mark forwarded WireGuard traffic from eth1 to route via main table (eth0)
        # This prevents eth1 traffic from being routed through Tailscale
        iifname "eth1" udp dport 51820 meta mark set 0x00100000 counter comment "Mark eth1 WG traffic"
    }
}

# NAT table
table ip nat {
    chain PREROUTING {
        type nat hook prerouting priority dstnat; policy accept;
    }

    chain POSTROUTING {
        type nat hook postrouting priority srcnat; policy accept;
        
        # Masquerade all traffic going through prague0 tunnel
        oifname "prague0" counter masquerade comment "NAT-prague0"
    }
}

# Filter table for forwarding rules
table inet filter {
    chain forward {
        type filter hook forward priority filter; policy accept;

        # Allow established and related connections
        ct state established,related counter accept

        # Allow WiFi and eth1 clients to use prague0 WireGuard tunnel
        iifname "wlan0" oifname "prague0" counter accept
        iifname "eth1" oifname "prague0" counter accept
        
        # Allow return traffic from prague0
        iifname "prague0" oifname "wlan0" counter accept
        iifname "prague0" oifname "eth1" counter accept

        # Allow WireGuard handshakes to go out eth0
        iifname "wlan0" oifname "eth0" udp dport 51820 counter accept
        iifname "eth1" oifname "eth0" udp dport 51820 counter accept

        # Kill switch: drop any other traffic from clients directly to eth0
        iifname "wlan0" oifname "eth0" counter drop
        iifname "eth1" oifname "eth0" counter drop
    }
}
